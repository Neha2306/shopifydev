{% if customer %}
    {% if customer.metafields.custom.quotationslists %}
        {% comment %} {% assign quotations = customer.metafields.custom.quotationslists.value %} {% endcomment %}
        {% assign path_parts = request.path | split: '/' %}
        {% assign quote_number = path_parts | last %}
        {% comment %} {% assign selected_quote = quotes | where: "quoteId", "QTN-000000000001" | first %} {% endcomment %}

        <div class="page-width">
            <div class="prepare-quotation-wrapper">
                <p>Hello, {{ customer.first_name }}!</p>
                <div id="prepare-quote-wrapper">

                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {       
                const quoteNumber = "{{ quote_number }}"; 
                fetch('/apps/customer-dashboard/customer/fetchquote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        quoteNumber: quoteNumber,
                    })
                })
                .then(async res => {
                    const text = await res.json();
                    const el = document.getElementById('prepare-quote-wrapper');
                    el.innerHTML = text.data;
                })
                .catch(err => console.error(err));
            });

            // Delegate click events (works for dynamically added elements)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('qty-btn')) {
                    const wrapper = e.target.closest('.quantity__wrapper');
                    const input = wrapper.querySelector('input[type="number"]');
                    let currentValue = parseInt(input.value);

                    if (e.target.classList.contains('plus')) {
                        input.value = currentValue + 1;
                    }

                    if (e.target.classList.contains('minus')) {
                        input.value = currentValue > 1 ? currentValue - 1 : 1;
                    }

                    // Optional: do something with the new quantity for this product
                    const productId = wrapper.dataset.productId;
                }
                
                if (e.target.matches(".update-quote-btn")) {
    
                    // Get all <li> items inside the product grid
                    const allLis = document.querySelectorAll("#product-grid li");

                    // Map each <li> to a structured object
                    const allQuoteData = Array.from(allLis).map(li => {
                        const priceInput = li.querySelector(".price");
                        const quantityInput = li.querySelector(".quantity");

                        return {
                            class: li.className,
                            price: priceInput ? parseFloat(priceInput.value) : 0,
                            quantity: quantityInput ? parseInt(quantityInput.value) : 0
                        };
                    });

                    console.log("All Quote Items:", allQuoteData);

                    // TODO: send allQuoteData via AJAX/fetch to update the server
                }
            });

        </script>
    {% endif %}
{% endif %}
{% schema %}
{
  "name": "Quotation",
  "settings": [],
  "presets": [
    {
      "name": "Quotation"
    }
  ]
}
{% endschema %}
