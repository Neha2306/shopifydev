<div class="main-page-wrapper" id="main-page-wrapper">
{% if customer %}
    {% if customer.metafields.custom.quotationslists %}
        {% assign quotations = customer.metafields.custom.quotationslists.value %}
        {% assign path_parts = request.path | split: '/' %}
        {% assign quote_number = path_parts | last %}
        {% assign selected_quote = quotations | where: "quoteId", quote_number | first %}
        {% if selected_quote %}
            {% assign selected_quote_json = selected_quote | json | replace: '\/', '/' %}
            {% assign secret = 'GBIOTFfgTECxHULMbbWSSZYUQAzxuGWaztyWPOL' %}
            {% assign signature = selected_quote_json | hmac_sha256: secret %}
            {{ shop.currency_symbol }}
            <div class="page-width">
                <input type="hidden" value="{{ signature }}" id="signature">
                <input type="hidden" value="{{ quote_number }}" id="quoteNumber">
                <form id="media-upload-form">
                <input type="file" name="file" id="file-input" accept="image/*" />
                <button type="submit">Upload to Shopify</button>
                </form>

                <div id="upload-result"></div>
                <div class="prepare-quotation-wrapper">
                    <p>Hello, {{ customer.first_name }}!</p>
                    <div id="prepare-quote-wrapper">

                    </div>
                </div>
            </div>
            <script>
                
                //Quote Fetch Request
                document.addEventListener('DOMContentLoaded', function () {  
                    const quoteNumber = document.getElementById('quoteNumber').value; 
                    fetch('/apps/customer-dashboard/customer/quote', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({
                            action: 'fetch_quote',
                            quoteNumber: quoteNumber,
                        })
                    })
                    .then(async res => {
                        const text = await res.json();
                        if(text.status) {
                            const el = document.getElementById('prepare-quote-wrapper');
                            el.innerHTML = text.data;
                        }
                    })
                    .catch(err => console.error(err));  
                });

                document.addEventListener('input', function(e) {
                    //Update DOM Elements whilte updating the Price
                    if (e.target.matches('.price__wrapper input[type="number"]')) {
                        const input = e.target;
                        input.value = Math.max(1, parseInt(input.value) || 1);
                        input.setAttribute('value', input.value);
                    }

                    //Update DOM Elements whilte updating the Quantity
                    if (e.target.matches('.quantity__wrapper input[type="number"]')) {
                        const input = e.target;
                        input.value = Math.max(1, parseInt(input.value) || 1);
                        input.setAttribute('value', input.value);
                    }

                    //Update DOM Elements whilte updating the Quote Title
                    if (e.target.id === 'quotation-title') {
                        e.target.setAttribute('value', e.target.value);
                    }

                    //Update DOM Elements whilte updating the Quote Note
                    if (e.target.id === 'quote-note') {
                        e.target.textContent = e.target.value;
                    }
                });

                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('qty-btn')) {
                        const wrapper = e.target.closest('.quantity__wrapper');
                        const input = wrapper.querySelector('input[type="number"]');
                        let currentValue = parseInt(input.value);

                        if (e.target.classList.contains('plus')) {
                            input.value = currentValue + 1;
                        }

                        if (e.target.classList.contains('minus')) {
                            input.value = currentValue > 1 ? currentValue - 1 : 1;
                        }

                        //Update DOM Elements whilte updating the Quantity
                        input.setAttribute('value', input.value);
                    }
                    
                    if (e.target.matches(".update-quote-btn")) {
                        const quoteNumber = document.getElementById('quoteNumber').value; 
                        const quoteTitle = document.getElementById('quotation-title').value;
                        const quoteNote = document.getElementById('quote-note').value ?? '';
                        const signature = document.getElementById('signature').value;
                        // Fetch All lis
                        const allLis = document.querySelectorAll("#product-grid li");

                        // Map all the details
                        const quoteDetails = Array.from(allLis).map(li => {
                            const productSku = li.querySelector(".product-sku");
                            const priceInput = li.querySelector(".price");
                            const quantityInput = li.querySelector(".quantity");

                            return {
                                class: li.className,
                                productSku: productSku ? productSku.innerText : '',
                                price: priceInput ? parseFloat(priceInput.value) : 0,
                                quantity: quantityInput ? parseInt(quantityInput.value) : 1
                            };
                        });

                        //Quote Update Request
                        fetch('/apps/customer-dashboard/customer/quote', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true',
                                'X-Signature': signature
                            },
                            body: JSON.stringify({
                                action: 'update_quote',
                                quoteNumber: quoteNumber,
                                quoteTitle: quoteTitle,
                                quoteDetails: quoteDetails,
                                quoteNote: quoteNote
                            })
                        })
                        .then(async res => {
                            const text = await res.json();
                            console.log("text");
                            console.log(text);
                            
                            if(text.status) {
                                const set1 = document.getElementById('prepare-quote-wrapper');
                                const url = new URL(window.location.href);
                                const response = await fetch(url.toString(), {
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                });
                                if (!response.ok) {
                                    console.error('Failed to refresh section', response.statusText);
                                    return;
                                }
                                const html = await response.text();
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const newSection = doc.getElementById('main-page-wrapper');
                                const el = document.getElementById('main-page-wrapper');
                                el.innerHTML = newSection.innerHTML;
                                const set = document.getElementById('prepare-quote-wrapper');
                                set.innerHTML = set1.innerHTML;
                            }
                        })
                        .catch(err => console.error(err));
                    }

                    if (e.target.matches(".download-quote-btn")) {
                        const quoteNumber = document.getElementById('quoteNumber').value; 
                        const signature = document.getElementById('signature').value;

                        fetch('/apps/customer-dashboard/customer/quote', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true',
                                'X-Signature': signature
                            },
                            body: JSON.stringify({
                                action: 'download_quote',
                                quoteNumber: quoteNumber
                            })
                        })
                        .then(res => res.blob()) // convert response to a Blob
                        .then(blob => {
                            // Create a temporary URL for the blob
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `quote-${quoteNumber}.pdf`; // filename
                            document.body.appendChild(a);
                            a.click(); // trigger download
                            a.remove(); // remove the temporary element
                            window.URL.revokeObjectURL(url); // free memory
                        })
                        .catch(err => console.error(err));
                    }
                });

                document.getElementById('media-upload-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('file-input');
                    if (!fileInput.files.length) return alert('Choose a file');

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);

                    const res = await fetch('/apps/customer-dashboard/customer/upload-media', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await res.json();
                    console.log("data");
                    console.log(data);
                    if (data.success) {
                        document.getElementById('upload-result').innerText = 'Uploaded: ' + data.file.url;
                    } else {
                        document.getElementById('upload-result').innerText = 'Error: ' + (data.error || 'Unknown');
                    }
                });
            </script>
        {% endif %}
    {% endif %}
{% endif %}
</div>
{% schema %}
{
  "name": "Quotation",
  "settings": [],
  "presets": [
    {
      "name": "Quotation"
    }
  ]
}
{% endschema %}
