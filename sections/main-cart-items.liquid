{{ 'component-cart.css' | asset_url | stylesheet_tag }}
{{ 'component-cart-items.css' | asset_url | stylesheet_tag }}
{{ 'component-totals.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-discounts.css' | asset_url | stylesheet_tag }}
{{ 'quantity-popover.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }


  .header-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.header-toggle__label {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.header-toggle__text {
  font-size: 0.9rem;
}

.header-toggle__switch {
  width: 40px;
  height: 22px;
  border-radius: 11px;
  border: 1px solid #ccc;
  background-color: #ddd;
  padding: 0;
  position: relative;
  cursor: pointer;
  outline: none;
  transition: background-color 0.2s ease;
}

.header-toggle__switch[aria-checked="true"] {
  background-color: #3a8bfd; /* active color */
}

.header-toggle__thumb {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: white;
  transition: transform 0.2s ease;
}

.header-toggle__switch[aria-checked="true"] .header-toggle__thumb {
  transform: translateX(18px);
}
{%- endstyle -%}

{%- unless settings.cart_type == 'drawer' -%}
  <script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>
{%- endunless -%}

<script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>



<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        attributes: {
          _last_refresh: String(Date.now()),
          isApplied: 'false'
        },
        sections: ['main-cart-items', 'main-cart-footer'],
        sections_url: window.location.pathname,
      }),
    });
    {% comment %} refreshMainContent(); {% endcomment %}
    {% comment %} refreshMainContent(); {% endcomment %}
    {% comment %} const data = await res.json();
    console.log("data");
    console.log(data);
    console.log(data.sections['main-cart-items']);
    const parser = new DOMParser();
    const mainCartItemData = parser.parseFromString(data.sections['main-cart-items'], 'text/html');
    const mainCartFooterData = parser.parseFromString(data.sections['main-cart-footer'], 'text/html');
    document.querySelector('#main-cart-items').replaceWith(mainCartItemData.querySelector(`#main-cart-items`));
    document.querySelector('#main-cart-footer').replaceWith(mainCartFooterData.querySelector(`#main-cart-footer`)); {% endcomment %}
  } catch (e) {
    console.error('Cart pre-refresh failed', e);
  }
});

function refreshMainContent() {
  const currentUrl = window.location.href; // or window.location.pathname

  return fetch(currentUrl, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest', // optional but useful to detect ajax on server if needed
    },
  })
    .then((res) => {
      if (!res.ok) {
        throw new Error(`Failed to fetch page HTML: ${res.status}`);
      }
      return res.text();
    })
    .then((html) => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const newMain = doc.querySelector('#MainContent');
      const currentMain = document.querySelector('#MainContent');

      if (!newMain || !currentMain) {
        console.error('Could not find #MainContent in new or current document');
        return;
      }

      // Replace all content inside #MainContent with the new version
      currentMain.innerHTML = newMain.innerHTML;

      // OPTIONAL: if your theme relies on some JS init after DOM changes,
      // you might call a re-init function here.
      initCartScriptsAgain();
    })
    .catch((error) => {
      console.error('Error refreshing #MainContent:', error);
    });
}

function initCartScriptsAgain() {
  // Re-bind your custom toggle
  const toggle = document.querySelector('[data-cart-toggle]');
  if (!toggle) return;

  // If we've already bound this toggle, skip
  if (toggle.dataset.toggleBound === 'true') return;
  toggle.dataset.toggleBound = 'true';

  toggle.addEventListener('click', async () => {
    const currentlyOn = toggle.getAttribute('aria-checked') === 'true';
    const newState = !currentlyOn;

    // Update the aria state & visual state immediately
    toggle.setAttribute('aria-checked', newState ? 'true' : 'false');

    try {
      // POST /cart/update.js to update attributes (triggers Cart Transform, etc.)
      const response = await fetch('/cart/update.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: JSON.stringify({
          attributes: {
            _last_refresh: String(Date.now()),
            isApplied: 'false'
          },
        }),
      });

      if (!response.ok) {
        console.error('Failed to update cart for header toggle', response.status);
        // Optionally revert the UI state on error
        toggle.setAttribute('aria-checked', currentlyOn ? 'true' : 'false');
        return;
      }

      const cart = await response.json();
      // Shopify has now re-run your cart transform function (if you have one)
window.location.reload();
      // If you want to re-render the cart page content:
      {% comment %} refreshMainContent(); // This call must exist in your other code {% endcomment %}

      // Or if you use a drawer:
      // updateMiniCartUI(cart);

    } catch (err) {
      console.error('Error calling /cart/update.js from header toggle', err);
      // Revert UI state on error
      toggle.setAttribute('aria-checked', currentlyOn ? 'true' : 'false');
    }
  });

  // If your theme has its own cart init, call it here:
  if (window.theme && typeof window.theme.initCart === 'function') {
    window.theme.initCart();
  }
}

initCartScriptsAgain();

</script>


{% schema %}
{
  "name": "t:sections.main-cart-items.name",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ]
}
{% endschema %}
